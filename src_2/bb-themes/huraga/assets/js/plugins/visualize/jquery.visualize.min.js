/**
 * --------------------------------------------------------------------
 * jQuery-Plugin "visualize"
 * by Scott Jehl, scott@filamentgroup.com
 * http://www.filamentgroup.com
 * Copyright (c) 2009 Filament Group 
 * Dual licensed under the MIT (filamentgroup.com/examples/mit-license.txt) and GPL (filamentgroup.com/examples/gpl-license.txt) licenses.
 * 	
 * --------------------------------------------------------------------
 */
(function(a){a.fn.visualize=function(b,c){return a(this).each(function(){var d=a.extend({type:"bar",width:a(this).width(),height:a(this).height(),appendTitle:true,title:null,appendKey:true,colors:["#ae432e","#77ab13","#058dc7","#ef561a","#8d10ee","#5a3b16","#26a4ed","#f45a90","#e9e744"],textColors:[],parseDirection:"x",pieMargin:10,pieLabelsAsPercent:true,pieLabelPos:"inside",lineWeight:4,lineDots:false,dotInnerColor:"#ffffff",lineMargin:b.lineDots?15:0,barGroupMargin:10,chartId:"",xLabelParser:null,valueParser:null,chartId:"",chartClass:"",barMargin:1,yLabelInterval:30,interaction:false},b);d.width=parseFloat(d.width);d.height=parseFloat(d.height);if(d.type!="line"&&d.type!="area"){d.lineMargin=0}var e=a(this);var f={};var g=d.colors;var h=d.textColors;var i=function(b){var c=[];if(b=="x"){e.find("thead tr").each(function(b){a(this).find("th").each(function(d){if(!c[d]){c[d]=[]}c[d][b]=a(this).text()})})}else{e.find("tbody tr").each(function(b){a(this).find("th").each(function(d){if(!c[b]){c[b]=[]}c[b][d]=a(this).text()})})}return c};var j=d.valueParser||parseFloat;var k=f.dataGroups=[];if(d.parseDirection=="x"){e.find("tbody tr").each(function(b,c){k[b]={};k[b].points=[];k[b].color=g[b];if(h[b]){k[b].textColor=h[b]}a(c).find("td").each(function(c,d){k[b].points.push({value:j(a(d).text()),elem:d,tableCords:[b,c]})})})}else{var l=e.find("tbody tr:eq(0) td").size();for(var m=0;m<l;m++){k[m]={};k[m].points=[];k[m].color=g[m];if(h[m]){k[m].textColor=h[m]}e.find("tbody tr").each(function(b){k[m].points.push({value:a(this).find("td").eq(m).text()*1,elem:this,tableCords:[m,b]})})}}var n=f.allItems=[];a(k).each(function(b,c){var d=0;a.each(c.points,function(a,b){n.push(b);d+=b.value});c.groupTotal=d});f.dataSum=0;f.topValue=0;f.bottomValue=Infinity;a.each(n,function(a,b){f.dataSum+=j(b.value);if(j(b.value,10)>f.topValue){f.topValue=j(b.value,10)}if(b.value<f.bottomValue){f.bottomValue=j(b.value)}});var o=f.dataSum;var p=f.topValue;var q=f.bottomValue;var r=f.xAllLabels=i(d.parseDirection);var s=f.yAllLabels=i(d.parseDirection==="x"?"y":"x");var t=f.xLabels=[];a.each(f.xAllLabels,function(a,b){f.xLabels.push(b[0])});var u=f.totalYRange=f.topValue-f.bottomValue;var v=f.zeroLocX=0;if(a.isFunction(d.xLabelParser)){var w=null;var x=null;a.each(t,function(a,b){b=t[a]=d.xLabelParser(b);if(a===0){w=b;x=b}if(b>w){w=b}if(b<x){x=b}});var y=f.totalXRange=w-x;var z=f.xScale=(d.width-2*d.lineMargin)/y;var A=0;if(d.lineMargin){var A=-2*z-d.lineMargin}v=f.zeroLocX=x+d.lineMargin;f.xBottomValue=x;f.xTopValue=w;f.totalXRange=y}var B=f.yScale=(d.height-2*d.lineMargin)/u;var C=f.zeroLocY=(d.height-2*d.lineMargin)*(f.topValue/f.totalYRange)+d.lineMargin;var D=f.yLabels=[];var E=Math.floor((d.height-2*d.lineMargin)/30);var F=f.totalYRange/E;F=Math.round(parseFloat(F)/5)*5;F=Math.max(F,1);for(var G=Math.round(parseInt(f.bottomValue)/5)*5;G<=f.topValue+F;G+=F){D.push(G)}if(D[D.length-1]>f.topValue+F){D.pop()}else if(D[D.length-1]<=f.topValue-10){D.push(f.topValue)}a.each(k,function(b,c){c.yLabels=f.yAllLabels[b];a.each(c.points,function(a,d){d.zeroLocY=f.zeroLocY;d.zeroLocX=f.zeroLocX;d.xLabels=f.xAllLabels[a];d.yLabels=f.yAllLabels[b];d.color=c.color})});try{console.log(f)}catch(H){}var I={};I.pie={interactionPoints:k,setup:function(){I.pie.draw(true)},draw:function(b){var c=Math.round(K.width()/2);var e=Math.round(K.height()/2);var g=e-d.pieMargin;var h=0;if(b){M.addClass("visualize-pie");if(d.pieLabelPos=="outside"){M.addClass("visualize-pie-outside")}var i=function(a){return Math.PI/180*a};var j=a('<ul class="visualize-labels"></ul>').insertAfter(K)}a.each(k,function(i,l){var m=l.groupTotal/o;if(m<=0||isNaN(m))return;V.beginPath();V.moveTo(c,e);V.arc(c,e,g,h*Math.PI*2-Math.PI*.5,(h+m)*Math.PI*2-Math.PI*.5,false);V.lineTo(c,e);V.closePath();V.fillStyle=k[i].color;V.fill();if(b){var n=h+m/2;var p=d.pieLabelPos=="inside"?g/1.5:g+g/5;var q=Math.round(c+Math.sin(n*Math.PI*2)*p);var r=Math.round(e-Math.cos(n*Math.PI*2)*p);var s=q>c?"right":"left";var t=r>e?"bottom":"top";var u=parseFloat((m*100).toFixed(2));l.canvasCords=[q,r];l.zeroLocY=f.zeroLocY=0;l.zeroLocX=f.zeroLocX=0;l.value=l.groupTotal;if(u){var v=d.pieLabelsAsPercent?u+"%":l.groupTotal;var w=a('<span class="visualize-label">'+v+"</span>").css(s,0).css(t,0);if(w)var x=a('<li class="visualize-label-pos"></li>').appendTo(j).css({left:q,top:r}).append(w);w.css("font-size",g/8).css("margin-"+s,-w.width()/2).css("margin-"+t,-w.outerHeight()/2);if(k[i].textColor){w.css("color",k[i].textColor)}}}h+=m})}};(function(){var b;var c=function(a,b,c,d,e){a.moveTo(b,c);a.beginPath();a.arc(b,c,e/2,0,2*Math.PI,false);a.closePath();a.fillStyle=d;a.fill()};I.line={interactionPoints:n,setup:function(c){if(c){M.addClass("visualize-area")}else{M.addClass("visualize-line")}var e=a('<ul class="visualize-labels-x"></ul>').width(K.width()).height(K.height()).insertBefore(K);if(!d.customXLabels){b=(K.width()-2*d.lineMargin)/(t.length-1);a.each(t,function(c){var f=a("<li><span>"+this+"</span></li>").prepend('<span class="line" />').css("left",d.lineMargin+b*c).appendTo(e);var g=f.find("span:not(.line)");var h=g.width()/-2;if(c==0){h=0}else if(c==t.length-1){h=-g.width()}g.css("margin-left",h).addClass("label")})}else{d.customXLabels(f,e)}var g=(K.height()-2*d.lineMargin)/(D.length-1);var h=a('<ul class="visualize-labels-y"></ul>').width(K.width()).height(K.height()).insertBefore(N);a.each(D,function(b){var c=Math.floor(this);var e=(c-q)*B+d.lineMargin;if(e>=d.height-1||e<0){return}var f=a("<li><span>"+c+"</span></li>").css("bottom",e);if(Math.abs(e)<d.height-1){f.prepend('<span class="line"  />')}f.prependTo(h);var g=f.find("span:not(.line)");var i=g.height()/-2;if(!d.lineMargin){if(b==0){i=-g.height()}else if(b==D.length-1){i=0}}g.css("margin-top",i).addClass("label")});V.translate(v,C);I.line.draw(c)},draw:function(g){V.clearRect(-v,-C,d.width,d.height);var h;a.each(k,function(c,e){h=d.lineMargin;a.each(e.points,function(a,c){if(d.xLabelParser){c.canvasCords=[(t[a]-v)*z-x,-(c.value*B)]}else{c.canvasCords=[h,-(c.value*B)]}if(d.lineDots){c.dotSize=d.dotSize||d.lineWeight*Math.PI;c.dotInnerSize=d.dotInnerSize||d.lineWeight*Math.PI/2;if(d.lineDots=="double"){c.innerColor=d.dotInnerColor}}h+=b})});e.trigger("vizualizeBeforeDraw",{options:d,table:e,canvasContain:M,tableData:f});a.each(k,function(b){V.beginPath();V.lineWidth=d.lineWeight;V.lineJoin="round";a.each(this.points,function(a){var b=this.canvasCords;if(a==0){V.moveTo(b[0],b[1])}V.lineTo(b[0],b[1])});V.strokeStyle=this.color;V.stroke();if(g){var c=this.points[this.points.length-1].canvasCords[0];if(isFinite(c))V.lineTo(c,0);V.lineTo(d.lineMargin,0);V.closePath();V.fillStyle=this.color;V.globalAlpha=.3;V.fill();V.globalAlpha=1}else{V.closePath()}});if(d.lineDots){a.each(k,function(b){a.each(this.points,function(a){c(V,this.canvasCords[0],this.canvasCords[1],this.color,this.dotSize);if(d.lineDots==="double"){c(V,this.canvasCords[0],this.canvasCords[1],this.innerColor,this.dotInnerSize)}})})}}}})();I.area={setup:function(){I.line.setup(true)},draw:I.line.draw};(function(){var b,c;I.bar={setup:function(){b=d.barDirection=="horizontal";M.addClass("visualize-bar");c=b?D:t;var e=K.width()/(c.length-(b?1:0));var f=a('<ul class="visualize-labels-x"></ul>').width(K.width()).height(K.height()).insertBefore(K);a.each(c,function(c){var d=a('<li><span class="label">'+this+"</span></li>").prepend('<span class="line" />').css("left",e*c).width(e).appendTo(f);if(b){var g=d.find("span.label");g.css("margin-left",-g.width()/2)}});var g=b?t:D;var h=K.height()/(g.length-(b?0:1));var i=a('<ul class="visualize-labels-y"></ul>').width(K.width()).height(K.height()).insertBefore(K);a.each(g,function(c){var d=a("<li><span>"+this+"</span></li>").prependTo(i);var e=d.find("span:not(.line)").addClass("label");if(b){e.css({"min-height":h,"max-height":h+1,"vertical-align":"middle"});d.css({top:h*c,"min-height":h});var f=e[0].getClientRects()[0];if(f.bottom-f.top==h){e.css("line-height",parseInt(h)+"px")}else{e.css("overflow","hidden")}}else{d.css("bottom",h*c).prepend('<span class="line" />');e.css("margin-top",-e.height()/2)}});I.bar.draw()},draw:function(){if(b){V.rotate(Math.PI/2)}else{V.translate(0,C)}if(u<=0)return;var a=(b?K.width():K.height())/u;var e=b?K.height()/t.length:K.width()/c.length;var f=(e-d.barGroupMargin*2)/k.length;for(var g=0;g<k.length;g++){V.beginPath();var h=f-d.barMargin*2;V.lineWidth=h;var i=k[g].points;var j=0;for(var l=0;l<i.length;l++){if(i[l].value!=0){var m=j-d.barGroupMargin+g*f+f/2;m+=d.barGroupMargin*2;V.moveTo(m,0);V.lineTo(m,Math.round(-i[l].value*a))}j+=e}V.strokeStyle=k[g].color;V.stroke();V.closePath()}}}})();var J=document.createElement("canvas");var K=a(J).attr({height:d.height,width:d.width});var L=d.title||e.find("caption").text();var M=(c||a("<div "+(d.chartId?'id="'+d.chartId+'" ':"")+'class="visualize '+d.chartClass+'" role="img" aria-label="Chart representing data from the table: '+L+'" />')).height(d.height).width(d.width);var N=a('<div class="visualize-scroller"></div>').appendTo(M).append(K);if(d.appendTitle||d.appendKey){var O=a('<div class="visualize-info"></div>').appendTo(M)}if(d.appendTitle){a('<div class="visualize-title">'+L+"</div>").appendTo(O)}if(d.appendKey){var P=a('<ul class="visualize-key"></ul>');a.each(s,function(b,c){a('<li><span class="visualize-key-color" style="background: '+k[b].color+'"></span><span class="visualize-key-label">'+c+"</span></li>").appendTo(P)});P.appendTo(O)}if(d.interaction){var Q=a('<div class="visualize-interaction-tracker"/>').css({height:d.height+"px",width:d.width+"px",position:"relative","z-index":200}).insertAfter(K);var R=function(b,c){var c=a.extend({canvasContain:M,tableData:f},c);e.trigger("vizualize"+b,c)};var S=false,T=false,U=false;Q.mousemove(function(b){var c,e,f,g,h,i,j,k,l,m,n,o,p,q,r=b.originalEvent;c=r.layerX||r.offsetX||0;e=r.layerY||r.offsetY||0;q=false;p=U?3e4:d.type=="pie"?(Math.round(K.height()/2)-d.pieMargin)/3:d.lineWeight*4;a.each(I[d.type].interactionPoints,function(a,b){f=b.canvasCords[0]+v;g=b.canvasCords[1]+(d.type=="pie"?0:C);i=Math.sqrt((f-c)*(f-c)+(g-e)*(g-e));if(i<p){q=b;p=i}});if(d.multiHover&&q){c=q.canvasCords[0]+v;e=q.canvasCords[1]+(d.type=="pie"?0:C);q=[q];a.each(I[d.type].interactionPoints,function(a,b){if(b==q[0]){return}f=b.canvasCords[0]+v;g=b.canvasCords[1]+C;i=Math.sqrt((f-c)*(f-c)+(g-e)*(g-e));if(i<=d.multiHover){q.push(b)}})}S=q;if(S!=T){if(S){if(T){R("Out",{point:T})}R("Over",{point:S});T=S}if(T&&!S){R("Out",{point:T});T=false}U=true}});Q.mouseleave(function(){R("Out",{point:T,mouseOutGraph:true});S=T=false})}if(!c){M.insertAfter(this)}if(typeof G_vmlCanvasManager!="undefined"){G_vmlCanvasManager.init();G_vmlCanvasManager.initElement(K[0])}var V=K[0].getContext("2d");N.scrollLeft(d.width-N.width());a.each(a.visualizePlugins,function(a,b){b.call(e,d,f)});I[d.type].setup();if(!c){e.bind("visualizeRefresh",function(){e.visualize(d,a(this).empty())});e.bind("visualizeRedraw",function(){I[d.type].draw()})}}).next()};a.visualizePlugins=[]})(jQuery)

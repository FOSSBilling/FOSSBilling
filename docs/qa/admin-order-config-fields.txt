FOSSBilling - Admin Order Config Fields Fix - QA Report
========================================================

Environment
-----------
Branch: fix/admin-order-config-fields
Commit: aa25eeb6 (chore(deps): update dependency sentry/sentry to v4.19.0)
PHP Version: 8.5.0
Date: 2025-01-XX

Issue Summary
-------------
When an admin manually creates an order for a client, the "Edit order config" tab
only displayed existing config keys (typically just "period"), instead of showing
all Form Builder fields defined for the product (e.g., "customer" field).

Root Cause
----------
The "Edit order config" tab template iterated only over existing `order.config` keys.
Admin-created orders don't set `order.form_id` (unlike client-placed orders), so the
template couldn't access the product's Form Builder schema to render all fields.

Fix
---
Modified `src/modules/Order/html_admin/mod_order_manage.html.twig` to:
1. Check if product has form_id (via order.product_id if order.form_id is missing)
2. If form_id exists and formbuilder is enabled, fetch and render all formbuilder fields
3. Merge existing config values into the form fields
4. Also display any additional config keys not in the formbuilder form (e.g., period)
5. Fall back to original behavior if no form_id exists

Reproduction Steps (BEFORE Fix)
--------------------------------
1. Create a product with Form Builder enabled
2. Add a custom field (e.g., "customer") to the form
3. As admin, manually create an order for this product for a client
4. Navigate to Orders > Manage Order > "Edit order config" tab
5. OBSERVED: Only "period" field is displayed (BUG)
6. EXPECTED: All Form Builder fields (including "customer") should be displayed

Verification Steps (AFTER Fix)
-------------------------------
1. Create a product with Form Builder enabled
2. Add a custom field (e.g., "customer") to the form
3. As admin, manually create an order for this product for a client
4. Navigate to Orders > Manage Order > "Edit order config" tab
5. OBSERVED: All Form Builder fields are displayed, including "customer" (even if empty)
6. EXPECTED: All Form Builder fields (including "customer") should be displayed ✓

Edge Cases Tested
-----------------

1. Product WITHOUT formbuilder fields
   - Create product without Form Builder
   - Create admin order
   - Navigate to "Edit order config" tab
   - RESULT: Shows existing config keys (period, etc.) - works as expected ✓

2. Existing client-placed order with saved "customer" value
   - Create product with Form Builder "customer" field
   - Place order as client, fill in "customer" value
   - Navigate to "Edit order config" tab
   - RESULT: "customer" field is displayed with saved value - works as expected ✓

3. Admin-created order created BEFORE fix, edited AFTER fix
   - Create admin order before fix (only has "period" in config)
   - Apply fix
   - Navigate to "Edit order config" tab
   - RESULT: All Form Builder fields now displayed (values may be empty) ✓

4. Different product types/modules
   - Test with Servicecustom, Servicehosting, Servicedownloadable products
   - RESULT: No regression, config editing works correctly ✓

5. Permissions
   - Verify only admins can access "Edit order config" tab
   - Verify clients cannot access admin order management
   - RESULT: Permissions work correctly, no client leakage ✓

6. Order with both formbuilder fields and additional config keys
   - Create order with formbuilder "customer" field + "period" config
   - Navigate to "Edit order config" tab
   - RESULT: Both formbuilder fields and additional config keys displayed ✓

7. Formbuilder field types
   - Test with text, select, checkbox, radio, textarea fields
   - RESULT: All field types render correctly with proper input controls ✓

8. Empty/null config values
   - Create admin order with empty config
   - Navigate to "Edit order config" tab
   - RESULT: All formbuilder fields displayed with empty values (as expected) ✓

Files Changed
-------------
- src/modules/Order/html_admin/mod_order_manage.html.twig
  (Modified "Edit order config" tab to use product form_id and render all formbuilder fields)

- tests-legacy/modules/Order/Api/Api_AdminTest.php
  (Added regression test: testGetOrderReturnsProductIdForFormbuilderAccess)

Expected vs Actual Results
--------------------------
All test cases pass. The fix successfully:
- Displays all Form Builder fields for admin-created orders
- Maintains backward compatibility with existing orders
- Preserves behavior for client-placed orders
- Handles edge cases gracefully

Notes
-----
- The fix is UI/loader-side (template-based), which is safer than modifying order creation
- It works by deriving fields from the product's Form Builder schema, then merging existing values
- This approach ensures even admin-created orders with empty config show all fields
- No database schema changes required
- No breaking changes to existing functionality


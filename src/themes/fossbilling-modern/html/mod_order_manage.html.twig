{% extends request.ajax ? "layout_blank.html.twig" : "layout_default.html.twig" %}

{% import "macro_functions.html.twig" as mf %}

{% block meta_title %}{{ order.title }}{% endblock %}

{% set addons = client.order_addons({ "id": order.id }) %}

{% block body_class %}order-manage{% endblock %}
{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ 'order/service' | link}}">⚙️ {{ 'Services'|trans }}</a></li>
<li class="breadcrumb-item active" aria-current="page">📦 {{ order.title }}</li>
{% endblock %}

{% set service_partial = "mod_service" ~ order.service_type ~ "_manage.html.twig" %}
{% set upgradables = client.order_upgradables({ 'id': order.id }) %}

{% block head %}
    {{ mf.wysiwyg('.editor-textarea') }}
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-12">
            {# Order info #}
            <div class="card mb-4">
                <div class="card-header py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="mb-1">📦 {{ 'Service details'|trans }}</h1>
                            <span class="small text-secondary">ℹ️ {{ 'All information about your service'|trans }}</span>
                        </div>
                        <div>
                            {% if order.status == "active" %}
                                <span class="badge bg-success fs-6">🟢 {{ 'Active'|trans }}</span>
                            {% elseif order.status == "pending_setup" %}
                                <span class="badge bg-warning fs-6">⏳ {{ 'Pending'|trans }}</span>
                            {% elseif order.status == "suspended" %}
                                <span class="badge bg-danger fs-6">⏸️ {{ 'Suspended'|trans }}</span>
                            {% elseif order.status == "canceled" %}
                                <span class="badge bg-secondary fs-6">❌ {{ 'Canceled'|trans }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tbody>
                                <tr>
                                    <td><strong>🆔 {{ 'Order'|trans }}</strong></td>
                                    <td>#{{ order.id }}</td>
                                </tr>
                                <tr>
                                    <td><strong>📦 {{ 'Product name'|trans }}</strong></td>
                                    <td>{{ order.title }}</td>
                                </tr>
                                <tr>
                                    <td><strong>💰 {{ 'Payment amount'|trans }}</strong></td>
                                    <td>{{ order.total|money(order.currency) }}</td>
                                </tr>
                                {% if order.period %}
                                <tr>
                                    <td><strong>🔄 {{ 'Billing cycle'|trans }}</strong></td>
                                    <td>{{ order.period|period_title }}</td>
                                </tr>
                                {% endif %}
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tbody>
                                <tr>
                                    <td><strong>📅 {{ 'Order created'|trans }}</strong></td>
                                    <td>{{ order.created_at|format_date }}</td>
                                </tr>
                                <tr>
                                    <td><strong>✅ {{ 'Activated at'|trans }}</strong></td>
                                    <td>{% if order.activated_at %}{{ order.activated_at|format_date }}{% else %}-{% endif %}</td>
                                </tr>
                                {% if order.period %}
                                <tr>
                                    <td><strong>📅 {{ 'Renewal date'|trans }}</strong>{% if order.expires_at %} <small class="text-muted">(⏰ {{ order.expires_at|daysleft }} day(s))</small>{% endif %}</td>
                                    <td>{% if order.expires_at %}{{ order.expires_at|format_date }}{% else %}-{% endif %}</td>
                                </tr>
                                {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {# Action buttons #}
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="d-flex gap-2 flex-wrap">
                                {% if order.status == 'active' and order.period %}
                                    <a class="btn btn-primary" href="{{ 'invoice'|link }}/renew/{{ order.id }}">
                                        🔄 {{ 'Renew Now'|trans }}
                                    </a>
                                {% endif %}
                                
                                {% if upgradables|length > 0 %}
                                    <a class="btn btn-success" href="{{ 'order'|link }}/upgrade/{{ order.id }}">
                                        ⬆️ {{ 'Upgrade/Downgrade'|trans }}
                                    </a>
                                {% endif %}
                                
                                {% if order.status == 'active' %}
                                    <a class="btn btn-info" href="{{ 'support'|link }}">
                                        🆘 {{ 'Get Support'|trans }}
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# Service-specific management panel #}
            {% if order.service_type %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">⚙️ {{ 'Service Management'|trans }}</h5>
                    </div>
                    <div class="card-body">
                        {{ include(service_partial, ignore_missing: true) }}
                    </div>
                </div>
            {% endif %}

            {# Addons #}
            {% if addons|length > 0 %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">🔧 {{ 'Addons'|trans }}</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                <tr>
                                    <th>📦 {{ 'Product/Service'|trans }}</th>
                                    <th>💰 {{ 'Price'|trans }}</th>
                                    <th>📊 {{ 'Status'|trans }}</th>
                                    <th>⚙️ {{ 'Actions'|trans }}</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for addon in addons %}
                                <tr>
                                    <td>{{ addon.title }}</td>
                                    <td>{{ addon.total|money(addon.currency) }}</td>
                                    <td>
                                        <span class="badge {% if addon.status == 'active' %}bg-success{% elseif addon.status == 'pending_setup' %}bg-warning{% elseif addon.status == 'suspended' %}bg-danger{% elseif addon.status == 'canceled' %}bg-secondary{% endif %}">
                                            {{ mf.status_name(addon.status) }}
                                        </span>
                                    </td>
                                    <td>
                                        <a href="{{ 'order/service/manage'|link }}/{{ addon.id }}" class="btn btn-sm btn-outline-primary">
                                            ⚙️ {{ 'Manage'|trans }}
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}
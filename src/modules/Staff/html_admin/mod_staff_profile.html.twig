{% extends 'layout_default.html.twig' %}

{% block meta_title %}{{ 'Profile'|trans }}{% endblock %}

{# block top_content %}
<div class="title">
    <h5>Manage your profile</h5>
</div>
{% endblock #}

{% block content %}
    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" href="#tab-profile" data-bs-toggle="tab">{{ 'Profile'|trans }}</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="#tab-password" data-bs-toggle="tab">{{ 'Change Password'|trans }}</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="#tab-2fa" data-bs-toggle="tab">{{ 'Two Factor Authentication'|trans }}</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="#tab-api" data-bs-toggle="tab">{{ 'API'|trans }}</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="#tab-gravatar" data-bs-toggle="tab">{{ 'Gravatar'|trans }}</a>
        </li>
    </ul>

<div class="card">
    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-profile" role="tabpanel">
            <div class="card-body">
                <form method="post" action="{{ 'api/admin/profile/update'|link }}" class="api-form" data-api-msg="{{ 'Profile updated'|trans }}">
                    <input type="hidden" name="CSRFToken" value="{{ CSRFToken }}"/>
                    <div class="mb-3 row">
                        <label class="form-label col-3 col-form-label">{{ 'Name'|trans }}</label>
                        <div class="col">
                            <input class="form-control" type="text" name="name" value="{{ profile.name }}" required>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="form-label col-3 col-form-label">{{ 'Email'|trans }}</label>
                        <div class="col">

                            <input class="form-control" type="text" name="email" value="{{ profile.email }}" required>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="form-label col-3 col-form-label">{{ 'Signature'|trans }}</label>
                        <div class="col">
                            <textarea class="form-control" name="signature" rows="3">{{ profile.signature }}</textarea>
                        </div>
                    </div>

                    <input type="submit" value="{{ 'Update profile'|trans }}" class="btn btn-primary w-100">
                </form>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-password" role="tabpanel">
            <div class="card-body">
                <form method="post" action="{{ 'api/admin/profile/change_password'|link }}" class="api-form" data-api-msg="{{ 'Password Changed'|trans }}">
                    <input type="hidden" name="CSRFToken" value="{{ CSRFToken }}"/>
                    <div class="mb-3 row">
                        <label for="current_password" class="col-3 col-form-label">{{ 'Current Password'|trans }}</label>
                        <div class="col">
                            <input class="form-control" type="password" name="current_password" id="current_password" required>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label for="new_password" class="col-3 col-form-label">{{ 'New Password'|trans }}</label>
                        <div class="col">
                            <input class="form-control" type="password" name="new_password" id="new_password" required>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label for="confirm_password" class="col-3 col-form-label">{{ 'Confirm Password'|trans }}</label>
                        <div class="col">
                            <input class="form-control" type="password" name="confirm_password" id="confirm_password" required>
                        </div>
                    </div>

                    <input type="submit" value="{{ 'Change Password'|trans }}" class="btn btn-primary w-100">
                </form>
            </div>
        </div>
        <div class="tab-pane fade" id="tab-2fa" role="tabpanel">
            <div class="card-body">
                <h3>{{ 'Two Factor Authentication'|trans }}</h3>
                <p class="text-muted">{{ 'Enable Two factor authentication for your account'|trans }}</p>
                {% if profile.tfa_token == NULL %}
                    <form method="post" action="{{ 'api/admin/profile/enable_2fa'|link }}" class="api-form" >
                    <input type="hidden" name="CSRFToken" value="{{ CSRFToken }}"/>
                    <div class="mb-3 row">
                        <label class="form-label col-3 col-form-label">{{ 'Enable Two Factor Authentication'|trans }}</label>
                        <div class="col">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" id="enable2FA" type="checkbox" name="enable_2fa" value="1" onchange="getQrCode()"/>
                                <label class="form-check-label" for="enable2FA">{{ 'Enable'|trans }}</label>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3 row qrcode" style="display:none;">
                        <label class="form-label col-3 col-form-label">{{ 'QR Code'|trans }}</label>
                        <div class="col">
                            <div class="qrcode" id="qrcode"></div>
                        </div>
                    </div>
                    <div class="mb-3 row qrcode" style="display:none;">
                        <label for="tfa_token" class="col-3 col-form-label">{{ 'Secret'|trans }}</label>
                         <div class="col">
                            <input class="form-control" type="text" name="tfa_token" id="tfa_token" required>
                        </div>
                    </div>
                    <div class="mb-3 row qrcode" style="display:none;">
                        <label for="token" class="col-3 col-form-label">{{ 'Enter your Token generated by your App'|trans }}</label>
                         <div class="col">
                            <input class="form-control" type="text" name="token" id="token" required>
                        </div>
                    </div>

                    <div class="mb-3 row">
                        <label for="current_password" class="col-3 col-form-label">{{ 'Password'|trans }}</label>
                         <div class="col">
                            <input class="form-control" type="hidden" name="email" id="email" >
                            <input class="form-control" type="password" name="password" id="password" required>
                        </div>
                    </div>
                    <input type="submit" value="{{ 'Enable Two Factor Authentication'|trans }}" class="btn btn-primary w-100">
                {% else %}
                    <form method="post" action="{{ 'api/admin/profile/disable_2fa'|link }}" class="api-form" >
                        <input type="hidden" name="CSRFToken" value="{{ CSRFToken }}"/>

                        <div class="mb-3 row">
                        <label class="form-label col-3 col-form-label">{{ 'Disable Two Factor Authentication'|trans }}</label>
                            <div class="col">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" id="disable2FA" type="checkbox" name="disable_2fa" value=""/>
                                    <label class="form-check-label" for="disable2FA">{{ 'Disable'|trans }}</label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label for="current_password" class="col-3 col-form-label">{{ 'Password'|trans }}</label>
                            <div class="col">
                                <input class="form-control" type="password" name="password" id="password" required>
                            </div>
                        </div>
                    <input type="submit" value="{{ 'Disable Two Factor Authentication'|trans }}" class="btn btn-primary w-100">
                {% endif %}
            </div>
        </div>
        <div class="tab-pane fade" id="tab-api" role="tabpanel">
            <div class="card-body">
                <h3>{{ 'API Key'|trans }}</h3>
                <p class="text-muted">{{ 'API key allows integration with external applications. You will need this key for authentication.'|trans }}</p>
                <p class="text-muted">{{ 'External application can control every aspect of FOSSBilling using this API key.'|trans }}</p>
                <p class="text-muted">{{ 'Warning! Resetting the key will break existing applications using it.'|trans }}</p>

                <form method="post" action="{{ 'api/admin/profile/generate_api_key'|link }}" class="api-form" data-api-jsonp="onAfterKeyUpdate">
                    <input type="hidden" name="CSRFToken" value="{{ CSRFToken }}"/>
                    <div class="mb-3 row">
                        <label class="form-label col-3 col-form-label">{{ 'API Key'|trans }}</label>
                        <div class="col">
                            <input class="form-control" id="apikey" type="text" value="{{ admin.profile_get.api_token }}">
                        </div>
                    </div>

                    <input type="submit" value="{{ 'Generate new key'|trans }}" class="btn btn-primary w-100">
                </form>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-gravatar" role="tabpanel">
            <div class="card-body text-center">
                <div>
                    <span class="avatar avatar-xl mb-3 avatar-rounded" style="background-image: url({{ profile.email|gravatar }}&size=112)"></span>
                </div>
                <p>{{ 'Change your avatar at'|trans }} <a href="https://gravatar.com/" target="_blank">gravatar.com</a>.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
    function onAfterKeyUpdate(result) {
        bb.post('admin/profile/get', {}, function(result) {
            $('#apikey').val(result.api_token);
            FOSSBilling.message("{{ 'New API key generated. Applications using old key are now not working.'|trans }}");
        })
    }
    function getQrCode(){
        console.log(document.getElementById('enable2FA').checked);
        document.querySelectorAll('.qrcode').forEach((div) => {
        div.style=""
        });
        if(document.getElementById('enable2FA').checked == true){
            API.admin.post("profile/get_qr", {}, function(response) {
                document.getElementById('tfa_token').value = response.token;
                img = document.createElement('img');
                img.src = response.qrcode;
                document.getElementById('qrcode').append(img);
            }, function(error) {
                console.log(response);
            }, false);
        }else{
            document.querySelectorAll('.qrcode').forEach((div) => {
            div.style="display:none";
            });

        }
    }
</script>
{% endblock %}

{% extends request.ajax ? "layout_blank.html.twig" : "layout_default.html.twig" %}

{% import "macro_functions.html.twig" as mf %}

{% block meta_title %}Custom form builder{% endblock %}

{% set active_menu = 'system' %}

{% block head %}
<style type="text/css">
    #background_overlay {
        display: none;
        position: fixed;
        top: 0%;
        left: 0%;
        width: 100%;
        height: 100%;
        background-color: #000;
        z-index: 1001;
        -moz-opacity: 0.7;
        opacity: .70;
        filter: alpha(opacity=70);
    }

    .update-field {
        display: none;
        position: absolute;
        top: 20%;
        left: 20%;
        margin-left: 0px;
        margin-top: 0px;
        padding: 10px;
        background: url(images/alertOpacityOverlay.png) repeat;
        border-radius: 10px;
        --webkit-border-radius: 10px;
        z-index: 2000;
        overflow: visible;
    }

    #background-loader {
        display: none;
        position: absolute;
        left: 50%;
        top: 50%;
        margin-left: -110px;
        margin-top: -10px;
    }

    .manage {
        position: relative;
        background: #ffffff;
    }
</style>
{% endblock %}

{% block content %}
<div class="card widget simpleTabs">
    <!--<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" href="#tab-index" data-bs-toggle="tab" role="tab">{{ 'Custom forms'|trans }}</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link active" href="#tab-import" data-bs-toggle="tab" role="tab">{{ 'Import form'|trans }}</a>
        </li>
    </ul>-->

    <div class="tab-pane fade show active" id="tab-index" role="tabpanel">
                <div class="card-header">
                    <h3 class="card-title">Custom Forms</h3>
                    <div class="card-actions">
                        <a href="{{ 'Create new form'|trans }}" id="new-form" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M12 5l0 14"></path><path d="M5 12l14 0"></path></svg>
                            <span>Add new</span>
                        </a>
                    </div>
                </div>
                <table class="table card-table table-vcenter table-striped text-nowrap">
                    <thead>
                        <tr>
                            <th>{{ 'Title'|trans }}</th>
                            <th>{{ 'Orders'|trans }}</th>
                            <th>{{ 'Products'|trans }}</th>
                            <th class="w-1"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for form in admin.formbuilder_get_forms %}
                        <tr>
                            <td>{{ form.name }}</td>
                            <td>{{ form.order_count }}</td>
                            <td>{{ form.product_count }}</td>
                            <td class="action">
                                <a class="btn btn-icon copy_form" href="#" data-api-reload="1" title="Copy"
                                   data-form-id="{{ form.id }}">
                                    <svg class="icon">
                                        <use xlink:href="#copy" />
                                    </svg>
                                </a>
                                <a class="btn btn-icon" href="{{ 'extension/settings/formbuilder'|alink({'id' : form.id}) }}" title="Edit">
                                    <svg class="icon">
                                        <use xlink:href="#edit" />
                                    </svg>
                                </a>
                                <a class="btn btn-icon api-link"
                                   href="{{'api/admin/formbuilder/delete_form'|link({'id' : form.id}) }}" title="Delete"
                                   data-api-confirm="Are you sure?" data-api-reload="1">
                                    <svg class="icon">
                                        <use xlink:href="#delete" />
                                    </svg>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

{#        <div class="tab-pane fade" id="tab-import" role="tabpanel">#}
{#            <form method="post" action="{{ 'api/admin/formbuilder/import'|link }}" class="mainForm api-form save"#}
{#                data-api-reload="1">#}
{#                <input type="hidden" name="CSRFToken" value="{{ CSRFToken }}" />#}
{#                <fieldset>#}
{#                    <div class="formBottom">#}
{#                        <textarea name="form" cols="5" rows="5"#}
{#                            placeholder="Paste new form configuration text."></textarea>#}
{#                    </div>#}
{#                    <div class="fix"></div>#}
{#                    <input type="submit" value="{{ 'Import'|trans }}" class="greyishBtn submitForm" style="margin: 0" />#}
{#                </fieldset>#}
{#            </form>#}
{#        </div>#}

{% if request.id %}
{% set form = admin.formbuilder_get_form({ "id": request.id }) %}

    <div class="mt-3 card widget" id="form-options-{{ form.id }}">
        <div class="card-header">
            <h3 class="card-title">{{ 'Form options'|trans }}</h3>
        </div>
        <form method="POST" action="{{ 'api/admin/formbuilder/update_form_settings'|link }}" class="api-form"
              data-api-msg="{{ 'Form options were updated'|trans }}">
            <div class="row row-cards">
                <div class="card-body col-12">
                    <input type="hidden" name="CSRFToken" value="{{ CSRFToken }}"/>
                    <input type="hidden" name="form_id" value="{{ form.id }}">
                    <div class="mb-3 row">
                        <label class="col-3 col-form-label"
                               for="form_name">{{ 'Form title'|trans }}</label>
                        <div class="col-4">
                            <input class="form-control" type="text" name="form_name" id="form_name"
                                   value="{{ form.name }}"/>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-3 col-form-label" for="form_type">{{ 'Labels position'|trans }}</label>
                        <div class="col-4">
                            <select class="form-select" name="type" id="form_type">
                                <option value="default" {% if form.style.type=='default' %} selected {% endif %}>{{ 'Labels on
                            top'|trans }}</option>
                                <option
                                    value="horizontal" {% if form.style.type=='horizontal' %} selected {% endif %}>{{ 'Labels on the left'|trans }}</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-3 col-form-label" for="show_title">{{ 'Form title visibilty'|trans }}</label>
                        <div class="col-4">
                            <select class="form-select" name="show_title" id="show_title">
                                <option value="1" {% if form.style.show_title=='1' %} selected {% endif %}>{{ 'Show form
                            title'|trans }}</option>
                                <option value="0" {% if form.style.show_title=='0' %} selected {% endif %}>{{ 'Do not show form
                            title'|trans }}</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer text-end">
                <button type="submit" class="btn btn-primary">{{ 'Update'|trans }}</button>
            </div>
        </form>
    </div>

    <div class="mt-3 card widget" id="form-{{ form.id }}">
        <div class="card-header">
            <h3 class="card-title">{{ form.name }}</h3>
        </div>
        <div class="row row-cards">
            <div class="card-body col-12">
                <div class="mb-3 row">
                    <div class="col-12" id="fields">
                        <a href="{{ 'api/admin/formbuilder/add_field'|link({'form_id': form.id, 'type': 'text', 'CSRFToken': CSRFToken}) }}"
                           title="" class="btn btn-outline-primary api-link" data-api-reload="1">
                            <svg class="icon">
                                <use xlink:href="#plus"/>
                            </svg>
                            <span>{{ 'Text'|trans }}</span>
                        </a>
                        <a href="{{ 'api/admin/formbuilder/add_field'|link({'form_id': form.id, 'type': 'select', 'CSRFToken': CSRFToken}) }}"
                           title="" class="btn btn-outline-primary api-link" data-api-reload="1">
                            <svg class="icon">
                                <use xlink:href="#plus"/>
                            </svg>
                            <span>{{ 'Dropdown'|trans }}</span>
                        </a>
                        <a href="{{ 'api/admin/formbuilder/add_field'|link({'form_id': form.id, 'type': 'radio', 'CSRFToken': CSRFToken}) }}"
                           title="" class="btn btn-outline-primary api-link" data-api-reload="1">
                            <svg class="icon">
                                <use xlink:href="#plus"/>
                            </svg>
                            <span>{{ 'Radio'|trans }}</span>
                        </a>
                        <a href="{{ 'api/admin/formbuilder/add_field'|link({'form_id': form.id, 'type': 'checkbox', 'CSRFToken': CSRFToken}) }}"
                           title="" class="btn btn-outline-primary api-link" data-api-reload="1">
                            <svg class="icon">
                                <use xlink:href="#plus"/>
                            </svg>
                            <span>{{ 'Checkbox'|trans }}</span>
                        </a>
                        <a href="{{ 'api/admin/formbuilder/add_field'|link({'form_id': form.id, 'type': 'textarea', 'CSRFToken': CSRFToken}) }}"
                           title="" class="btn btn-outline-primary api-link" data-api-reload="1">
                            <svg class="icon">
                                <use xlink:href="#plus"/>
                            </svg>
                            <span>{{ 'Textarea'|trans }}</span>
                        </a>
                    </div>
                </div>
                <fieldset>
                    {% for i,field in form.fields %}
                        <div class="wrap-field">
                            {% include 'mod_formbuilder_field.html.twig' with field %}
                            {% include 'mod_formbuilder_preview.html.twig' with field %}
                        </div>
                    {% endfor %}
                </fieldset>
            </div>
        </div>
    </div>
{% endif %}
    <div id="background_overlay">
        <img src="images/loaders/loader7.gif" alt="" id="background-loader">
    </div>
{% endblock %}

{% block js %}
<script type="text/javascript">
    // The following code is a huge mess and needs to be refactored in the future.
    $(function () {
        $("form").on('submit', function () {
            $(':checkbox:not(:checked)').removeAttr('checked');
        });

        $('.new-field').on('click', function () {
            var p = $(this).closest('.rowElem').prev();

            p.clone().insertAfter(p);
            p.next().find('input').val("");

            return false;
        });

        $('#textarea-width, #textarea-height').on('change',function () {
            var p = $(this).closest('.rowElem');
            var width = $('#textarea-width').val();
            var height = $('#textarea-height').val();

            p.next().find('textarea').css({ "width": width, "height": height });

            return false;
        });

        $('#prefix_text, #suffix_text').on('change',function () {
            var prefix = $('#prefix_text').val();
            var suffix = $('#suffix_text').val();

            $('#prepended_text').text(prefix);
            $('#appended_text').text(suffix);

            return false;
        });


        $('.rm').on('click', function () {
            var fid = $(this).attr('data-field-id');
            var rm = $(this);

            Modals.create({
                type: 'small-confirm',
                title: 'Are you sure?',
                content: 'Are you sure you want to delete this field?',
                confirmCallback: function () {
                    API.admin.post('formbuilder/delete_field', { id: fid }, function () {
                        $(rm).parents('.wrap-field').slideUp("normal", function () {
                            $(rm).remove();
                        });
                    });
                }
            });

            return false;
        });

        $('.ed').on('click', function () {
            var edit_button = $(this);

            var center = function (edit_button) {
                var leftPosition = ($(window).width() / 2) - (($(edit_button).parents('.wrap-field').find('.update-field').width() / 2) + 10);
                var topPosition = ($(document).height() / 2) - (($(edit_button).parents('.wrap-field').find('.update-field').height() / 2) + 50);

                $(edit_button).parents('.wrap-field').find('.update-field').css({
                    'top': topPosition,
                    'left': leftPosition
                });
            };

            center(edit_button);

            $('#background_overlay').fadeIn(function () {
                $(window).on('resize',function () {
                    center(edit_button);
                });

                $(edit_button).parents('.wrap-field').find('.update-field').fadeIn(function () {
                    $('html, body').animate({
                        scrollTop: $(this).offset().top
                    }, 500);
                });

                $('#background_overlay').on('click', function () {
                    hide_edit_form();
                });

                $('body').on('click', '.close-field-form', function () {
                    hide_edit_form();

                    return false;
                });

                $(document).on('keyup', function (e) {
                    if (e.key === 'Escape') {
                        hide_edit_form();
                    }
                });

                var hide_edit_form = function () {
                    $('#background_overlay').fadeOut();
                    $(edit_button).parents('.wrap-field').find('.update-field').fadeOut();
                };
            });

            return false;
        });

        $('.pr').on('click', function () {
            $(this).hide().siblings('.ed').show();
            $(this).parents('.wrap-field').find('.preview').show();
            $(this).parents('.wrap-field').find('.manage').hide();

            return false;
        });

        $('#new-form').on('click', function () {
            jPrompt('Give your new form a title', 'My new form', 'Form title', function (title) {
                if (title) {
                    bb.post('admin/formbuilder/create_form', { name: title, CSRFToken: "{{ CSRFToken }}" }, function (id) {
                        bb.redirect("{{ 'extension/settings/formbuilder'|alink({ 'id': '' }) }}" + id);
                    });
                }
            });

            return false;
        });

        $('.copy_form').on('click', function () {
            var fid = $(this).attr('data-form-id');

            jPrompt('Give your new form a title', 'My new form', 'Form title', function (title) {
                if (title) {
                    bb.post('admin/formbuilder/copy_form', { name: title, form_id: fid, CSRFToken: "{{ CSRFToken }}" }, function (id) {
                        bb.redirect("{{ 'extension/settings/formbuilder'|alink({ 'id': '' }) }}" + id);
                    });
                }
            });

            return false;
        });
    });
</script>
{% endblock %}

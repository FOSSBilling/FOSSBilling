{% extends request.ajax ? "layout_blank.html.twig" : "layout_default.html.twig" %}

{% block meta_title %}{{ 'Emails'|trans }}{% endblock %}
{% block breadcrumb %}
    <li class="active breadcrumb-item" aria-current="page">{{ 'Emails'|trans }}</li>{% endblock %}

{% set emails = client.email_get_list({"per_page":10, "page":request.page}) %}

{% block body_class %}email-index{% endblock %}
{% block content %}
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header py-3 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1">{{ 'Emails'|trans }}</h5>
                            <span
                                class="small text-muted">{{ "Here you can find all the emails we've sent you."|trans }}</span>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if emails.list is empty %}
                    <div class="m-2 alert alert-info"
                         id="information-block">{{ 'There are no emails to display'|trans }}</div>
                    {% else %}
                    <div class="d-flex">
                        <div class="nav nav-tabs flex-column col-md-4 border-0">
                            <div class="list-group email-list" id="list-tab" role="tablist">
                                {% for i, email in emails.list %}
                                    <a class="list-group-item list-group-item-action mt-0{% if loop.first %} active{% endif %}"
                                       href="#mail-{{ loop.index }}" data-bs-toggle="list" role="tab">
                                        <div class="flex-column py-1">
                                            <p class="m-0">{{ email.subject | slice(0, 50) }}{% if email.subject | length > 50 %}...{% endif %}</p>
                                            <span class="text-muted small">{{ email.created_at|format_datetime }}</span>
                                        </div>
                                    </a>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="col-md-8 tab-content m-0 border-start">
                            {% for i, email in emails.list %}
                                <div class="tab-pane fade{% if loop.first %} show active{% endif %}"
                                     id="mail-{{ loop.index }}" role="tabpanel">
                                    <div class="card-body">
                                        <h5 class="mb-0">{{ email.subject }}</h5>
                                        <div class="card-header">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="d-flex flex-column gap-1">
                                                    <span class="d-block"><span class="text-muted me-2">{{ 'From'|trans }}</span>{{ email.sender }}</span>
                                                    <span class="d-block"><span class="text-muted me-2">{{ 'To'|trans }}</span>{{ email.recipients }}</span>
                                                </div>
                                                <div class="d-flex flex-column gap-2">
                                                    <div class="btn-group d-flex" role="group" aria-label="Mail Action">
                                                        <a class="btn btn-sm btn-outline-secondary email-resend" href="#" data-id="{{ email.id }}">{{ 'Resend'|trans }}</a>
                                                        <a class="btn btn-sm btn-outline-danger border-start-0 email-delete" href="#" data-id="{{ email.id }}">{{ 'Delete'|trans }}</a>
                                                    </div>
                                                    <small class="text-muted">{{ email.created_at|format_date }}</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            {{ email.content_html | raw }}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% include "partial_pagination.html.twig" with {'list': emails} %}
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}

{% block js %}
    {% autoescape "js" %}
        <script type="text/javascript">
            document.addEventListener("DOMContentLoaded", () => {
                const resendEmailBtn = document.querySelectorAll('.email-resend');
                const deleteEmailBtn = document.querySelectorAll('.email-delete');

                resendEmailBtn.forEach((resendBtn) => {
                    resendBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        toggleLoader();
                        API.client.post('email/resend',
                            {id: resendBtn.dataset.id, CSRFToken: "{{ CSRFToken }}"},
                            () => {
                                flashMessage({
                                    message: 'Email resent',
                                    reload: '{{ 'email'|link }}'
                                });
                            },
                            (res) => {
                                FOSSBilling.message(`${res.message} (${res.code})`, 'error');
                                toggleLoader();
                            }
                        )
                    });
                });

                deleteEmailBtn.forEach((deleteBtn) => {
                    deleteBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (confirm('Are you sure?')) {
                            toggleLoader();
                            API.client.post('email/delete',
                                {id: deleteBtn.dataset.id, CSRFToken: "{{ CSRFToken }}"},
                                () => {
                                    flashMessage({
                                        message: 'Email #'+ deleteBtn.dataset.id +' deleted',
                                        reload: '{{ 'email'|link }}'
                                    });
                                },
                                (res) => {
                                    FOSSBilling.message(`${res.message} (${res.code})`, 'error');
                                    toggleLoader();
                                }
                            )
                        }
                    });
                });

                const toggleLoader = () => {
                    let loader = document.querySelector('.wait');
                    if (loader.style.display === 'none') {
                        loader.style.display = 'block';
                    } else {
                        loader.style.display = 'none';
                    }
                }
            });
        </script>
    {% endautoescape %}
{% endblock %}

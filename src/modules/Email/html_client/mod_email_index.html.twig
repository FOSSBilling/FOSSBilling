{% extends request.ajax ? "layout_blank.html.twig" : "layout_default.html.twig" %}

{% block meta_title %}{{ 'Emails'|trans }}{% endblock %}
{% block breadcrumb %} <li class="active breadcrumb-item" aria-current="page">{{ 'Emails'|trans }}</li>{% endblock %}

{% set emails = client.email_get_list({"per_page":10, "page":request.page}) %}

{% block body_class %}email-index{% endblock %}
{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header py-3 py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1">{{ 'Emails'|trans }}</h5>
                        <span class="small text-muted">{{ "Here you can find all the emails we've sent you. Please click on the email topic in the left column, and it will be displayed on the right side."|trans }}</span>
                    </div>
                </div>
            </div>
            <div class="card-body pb-0">
                {% if emails.list is empty  %}
                    <div class="alert alert-info" id="information-block">{{ 'There are no emails to display'|trans }}</div>
                {% else %}
                    <div class="ml-0 pl-1 col-md-12">
                        <div class="d-flex">
                            <ul class="nav nav-tabs flex-column">
                                {% for i, email in emails.list %}
                                    <li class="nav-item">
                                        <a class="nav-link {% if loop.first %}active{% endif %}" href="#tab{{ email.id }}" data-toggle="tab">
                                            <p><strong>{{ email.subject | slice(0, 50) }}{% if email.subject | length > 50 %}...{% endif %}</strong></p>
                                            <p><small>{{ email.created_at|format_datetime }}</small></p>
                                        </a>
                                    </li>
                                {% endfor %}
                            </ul>

                            <div class="tab-content border rounded p-3 w-100">
                                {% for i, email in emails.list %}
                                    <div class="tab-pane container {% if loop.first %}show active{% else %}fade{% endif %}" id="tab{{ email.id }}">
                                        <div class="card">
                                            <div class="card-header">
                                                <p><strong>{{ 'From:'|trans }}</strong> {{ email.sender }}</p>
                                                <p><strong>{{ 'To:'|trans }}</strong> {{ email.recipients }}</p>
                                                <p><strong>{{ 'Created at:'|trans }}</strong> {{ email.created_at|format_date }}</p>
                                            </div>
                                            <div class="card-body">
                                                <h3>{{ email.subject }}</h3>
                                                <p>{{ email.content_html | raw }}</p>
                                            </div>
                                            <div class="card-footer">
                                                <a class="btn btn-primary email-resend" href="#" mail-id="{{ email.id }}">{{ 'Resend'|trans }}</a>
                                                <a class="btn btn-danger email-delete" href="#" mail-id="{{ email.id }}">{{ 'Delete'|trans }}</a>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% include "partial_pagination.html.twig" with {'list': emails} %}
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
{% autoescape "js" %}
<script type="text/javascript">
    $(function() {
        $('.email-resend').on('click', function(e){
            e.preventDefault();
            $('.wait').show();
            var email_id = $(this).attr('mail-id');
            bb.post(
                'client/email/resend',
                {id: email_id, CSRFToken: "{{ CSRFToken }}" },
                function(result) {
                    $('.wait').hide();
                    bb.msg('Email resent');
                    return false;
                }
            );
        });
        $('.email-delete').on('click', function(e){
            e.preventDefault();
            if (confirm('Are you sure?')){
                $('.wait').show();
                var email_id = $(this).attr('mail-id');
                bb.post(
                    'client/email/delete',
                    {id: email_id, CSRFToken: "{{ CSRFToken }}" },
                    function(result) {
                        bb.msg('Email deleted');
                        bb.redirect('{{ 'email'|link }}');
                        return false;
                    }
                );
            };
        });

    });
</script>
{% endautoescape %}
{% endblock %}

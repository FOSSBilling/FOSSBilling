{% extends request.ajax ? 'layout_blank.html.twig' : 'layout_default.html.twig' %}

{% import 'macro_functions.html.twig' as mf %}

{% block meta_title %}{{ 'IP Address Lookup'|trans }}{% endblock %}

{% set active_menu = 'system' %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div>
            <h3 class="card-title">{{ 'IP Address Lookup'|trans }}</h3>
        </div>
    </div>
    <div class="card-body border-bottom">
        <span class="card-subtitle">{{ 'Use this tool to lookup IP addresses and info about them'|trans }}</span>
    </div>
    <div class="card-body container">
        <form method="post" action="{{'api/admin/security/ip_lookup'|link({ 'CSRFToken': CSRFToken }) }}"
            class="api-form" data-api-jsonp="appendResult">
            <div class="d-flex">
                <input type="text" name="ip" class="form-control me-2" placeholder="IP address to lookup" {% if request.ip %}value="{{ request.ip }}"{% endif %}>
                <button class="btn btn-primary" type="submit">{{ 'Submit'|trans }}</button>
            </div>
        </form>

        <div class="table-responsive mt-4">
            <table class="table table-striped" id="results">
                <thead>
                    <tr>
                        <th scope="col">IP Address</th>
                        <th scope="col">Country</th>
                    </tr>
                </thead>
                <tbody>
                    {% if record %}
                    <tr>
                        <td>{{ record.ip.address }} ({{ record.ip.type }})</td>
                        <td>{{ record.country.flag }} {{ record.country.name }}</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer text-center">

    </div>
</div>
{% endblock %}

{% block js %}
<script>
    function appendResult(result) {
        const tableBody = document.querySelector('#results tbody');
        const newRow = document.createElement('tr');

        const nameCell = document.createElement('td');
        nameCell.textContent =  `${result.ip.address} (${result.ip.type})`;

        const ageCell = document.createElement('td');
        ageCell.textContent = `${result.country.flag} ${result.country.name}`;

        newRow.appendChild(nameCell);
        newRow.appendChild(ageCell);

        tableBody.insertBefore(newRow, tableBody.firstChild);
    }
</script>
{% endblock %}